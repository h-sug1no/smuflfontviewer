<!DOCTYPE html>
<html>

<head>
  <meta name="copyright" content="Copyright (c) 2019 h-sug1no">
  <title>SMuFL font viewer launcher</title>
  <style>
  #options div label {
    display: inline-block;
    width: 9em;
  }
  #options div input {
    width: calc(100vw - 20em)
  }

  </style>
</head>
  <body>
    <div id="container">
      <select id="demolist">
      </select>
        <hr>
        <div id="options">
          <div class="item">
            <label>fontUrl</label> <input>
          </div>
          <div class="item">
            <label>fontMetadataUrl</label> <input>
          </div>
          <hr>
          SMuFL metadata:
          <div class="item">
            <label>glyphnamesUrl</label> <input>
          </div>
          <div class="item">
            <label>classesUrl</label> <input>
          </div>
          <div class="item">
            <label>rangesUrl</label> <input>
          </div>
          <hr>
          <div class="item">
            <label title="codepoint(ex..:E0A3) or glyphname(ex...:noteheadHalf)">glyph</label> <input>
          </div>
        </div>
        <hr>
        <button id="openBtn">open</button>
    </div>

    <script>
      (function() {
        const urlObject = new URL(location);
        const containerElm = document.querySelector('#container');
        const demolistElm = document.querySelector('#demolist');
        const openBtnElm = document.querySelector('#openBtn');

        if (!window.FontFace) {
          alert('no window.FontFace. This browser is not supported.');
          openBtnElm.disabled = true;
        }


        const _itemInputMap = {};
        containerElm.querySelectorAll('div.item').forEach(function(divItemElm) {
          const itemDataElm = divItemElm.querySelector('label');
          _itemInputMap[itemDataElm.textContent] = divItemElm.querySelector('input');
        });

        containerElm.addEventListener('change', function(ev) {
          //console.log(ev);
          if (ev.target === demolistElm) {
            const item = demolistElm.querySelectorAll('option')[demolistElm.selectedIndex];
            updateOptions(item._jsOptions);
          }
        });

        let wid = 0;
        containerElm.addEventListener('click', function(ev) {
          if (ev.target === openBtnElm) {
            window.open(createUrl(), '_smuflfontviewer_app_' + (++wid));
          }
        });

        function updateOptions(options) {
          Object.keys(options).forEach(function(key) {
            _itemInputMap[key].value = options[key];
          });
        }

        function createUrl() {
          const url = new URL('./app.html', location);
          for (let key in _itemInputMap) {
            url.searchParams.set(key, _itemInputMap[key].value);
          }
          return url;
        }

        function addDemolistItem(text, options) {
          var optionElm = document.createElement('option');
          optionElm.textContent = optionElm.value = text;
          optionElm._jsOptions = options;
          demolistElm.appendChild(optionElm);
        }

        function _createDemolistOptions(lFontBasePath, lMetadataBasePath, optFontPath, optFontMetadataPath) {
            return {
              fontUrl: lFontBasePath + (optFontPath || '/woff/Bravura.woff2'),
              fontMetadataUrl: lFontBasePath + (optFontMetadataPath || '/bravura_metadata.json'),
              glyphnamesUrl: lMetadataBasePath + '/glyphnames.json',
              classesUrl: lMetadataBasePath + '/classes.json',
              rangesUrl: lMetadataBasePath + '/ranges.json'
            };
        }

        if (urlObject.searchParams.get('dev') !== null) {
          // mkdir ./packages
          // and clone followings in packages/.
          //   https://github.com/w3c/smufl.git
          //   https://github.com/steinbergmedia/bravura
          //   https://github.com/steinbergmedia/petaluma
          //
          addDemolistItem('local Bravura(debug)', _createDemolistOptions(
            './packages/bravura/redist',
            './packages/smufl/metadata'
          ));
          addDemolistItem('local Petaluma(debug)', _createDemolistOptions(
            './packages/petaluma/redist',
            './packages/smufl/metadata',
            '/woff/Petaluma.woff2', '/petaluma_metadata.json'
          ));
        }

        addDemolistItem('steinbergmedia/bravura/master + w3c/smufl', _createDemolistOptions(
          'https://raw.githubusercontent.com/steinbergmedia/bravura/master/redist',
          'https://raw.githubusercontent.com/w3c/smufl/gh-pages/metadata'
        ));

        addDemolistItem('steinbergmedia/petaluma/master + w3c/smufl', _createDemolistOptions(
          'https://raw.githubusercontent.com/steinbergmedia/petaluma/master/redist',
          'https://raw.githubusercontent.com/w3c/smufl/gh-pages/metadata',
          '/woff/Petaluma.woff2', '/petaluma_metadata.json'
        ));

        var evt = new Event("change", {"bubbles":true, "cancelable":true});
        demolistElm.dispatchEvent(evt);
      })();
    </script>
  </body>
</html>
